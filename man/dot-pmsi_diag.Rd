% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/pmsi.R
\name{.pmsi_diag}
\alias{.pmsi_diag}
\title{Extract PMSI diagnoses from the DALL field}
\usage{
.pmsi_diag(data)
}
\arguments{
\item{data}{A tibble produced by `.pmsi_prepare()`.}
}
\value{
A tibble with stay identifiers (`*_ID` columns present in `data`),
  `DATENT`, `HEURE_DATENT`, `DATSORT`, `HEURE_DATSORT`, plus:
  - `diag`: the substring after `:` (may be `NA` if no `:` is present)
  - `type_diag`: the first two characters of the token
}
\description{
Creates a diagnoses table by splitting the `DALL` field (space-separated
tokens) into one row per token and parsing diagnosis code and type.
}
\details{
The function expects `DALL` entries to follow a pattern like `"TT:CODE"`
where `TT` is a 2-character type prefix (e.g., "01", "02") and `CODE` is the
diagnosis identifier. Tokens without digits are dropped.


Processing steps:
1. Keep ID columns (`ends_with("ID")`), dates/times, and `DALL`
2. `separate_rows(DALL, sep = " ")`
3. Keep only tokens containing at least one digit (`str_detect(DALL, "\\d")`)
4. Derive `diag` and `type_diag`, then drop the raw `DALL` column
}
\examples{
x <- list(list(PATID="P1", EVTID="E1", ELTID="L1",
               DATENT="2020-01-01 08:30", DALL="01:A41 02:I10"))
cleaned <- .pmsi_prepare(x)
diag <- .pmsi_diag(cleaned)

}
\keyword{internal}
